# RetailAnalytics

## Logical view of database model

### Входные данные

###_________________________________________________Описание содержания таблиц_________________________________________________

####_________________________________________________Таблица Персональные данные_________________________________________________

| **Поле**                    | **Название поля в системе** | **Формат / возможные значения**                                                  | **Описание** |
|:---------------------------:|:---------------------------:|:--------------------------------------------------------------------------------:|:------------:|
| Идентификатор клиента       | Customer_ID                 | ---                                                                              | ---          |
| Имя                         | Customer_Name               | Кириллица или латиница, первая буква заглавная, остальные прописные, допустимы тире и пробелы | ---          |
| Фамилия                     | Customer_Surname            | Кириллица или латиница, первая буква заглавная, остальные прописные, допустимы тире и пробелы | ---          |
| E-mail клиента              | Customer_Primary_Email      | Формат E-mail                                                                    | ---          |
| Телефон клиента             | Customer_Primary_Phone      | +7 и 10 арабских цифр                                                                 | ---          |

#### _________________________________________________Таблица Карты_________________________________________________

| **Поле**              | **Название поля в системе** | **Формат / возможные значения** | **Описание**                                     |
|:---------------------:|:---------------------------:|:-------------------------------:|:------------------------------------------------:|
| Идентификатор карты   | Customer_Card_ID            | ---                             | ---                                              |
| Идентификатор клиента | Customer_ID                 | ---                             | Одному клиенту может принадлежать несколько карт |

#### _________________________________________________Таблица Транзакции_________________________________________________

| **Поле**                 | **Название поля в системе** | **Формат / возможные значения** | **Описание**                                                          |
|:------------------------:|:---------------------------:|:-------------------------------:|:---------------------------------------------------------------------:|
| Идентификатор транзакции | Transaction_ID              | ---                             | Уникальное значение                                                   |
| Идентификатор карты      | Customer_Card_ID            | ---                             | ---                                                                   |
| Сумма транзакции         | Transaction_Summ            | Арабская цифра                  | Сумма транзакции в рублях (полная стоимость покупки без учета скидок) |
| Дата транзакции          | Transaction_DateTime        | дд.мм.гггг чч:мм:сс             | Дата и время совершения транзакции                                    |
| Торговая точка           | Transaction_Store_ID        | Идентификатор магазина          | Магазин, в котором была совершена транзакция                          |

#### _________________________________________________Таблица Чеки_________________________________________________

| **Поле**                            | **Название поля в системе** | **Формат / возможные значения** | **Описание**                                                                                            |
|:-----------------------------------:|:---------------------------:|:-------------------------------:|:-------------------------------------------------------------------------------------------------------:|
| Идентификатор транзакции            | Transaction_ID              | ---                             | Идентификатор транзакции указывается для всех позиций в чеке                                            |
| Позиция в чеке                      | SKU_ID                      | ---                             | ---                                                                                                     |
| Количество штук или килограмм       | SKU_Amount                  | Арабская цифра                  | Указание, какое количество товара было куплено                                                          |
| Сумма, на которую был куплен товар  | SKU_Summ                    | Арабская цифра                  | Сумма покупки фактического объема данного товара в рублях (полная стоимость без учета скидок и бонусов) |
| Оплаченная стоимость покупки товара | SKU_Summ_Paid               | Арабская цифра                  | Фактически оплаченная сумма покупки данного товара, не включая сумму предоставленной скидки             |
| Предоставленная скидка              | SKU_Discount                | Арабская цифра                  | Размер предоставленной на товар скидки в рублях                                                         |

#### _________________________________________________Таблица Товарная матрица_________________________________________________

| **Поле**                    | **Название поля в системе** | **Формат / возможные значения**        | **Описание**                                                                                                                                                                                                 |
|:---------------------------:|:---------------------------:|:--------------------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| Идентификатор товара        | SKU_ID                      | ---                                    | ---                                                                                                                                                                                                          |
| Название товара             | SKU_Name                    | Кириллица или латиница, арабские цифры, спецсимволы | ---                                                                                                                                                                                                          |
| Группа SKU                  | Group_ID                    | ---                                    | Идентификатор группы родственных товаров, к которой относится товар (например, одинаковые йогурты одного производителя и объема, но разных вкусов). Указывается один идентификатор для всех товаров в группе |

#### _________________________________________________Таблица Торговые точки_________________________________________________

| **Поле**                    | **Название поля в системе** | **Формат / возможные значения** | **Описание**                                                   |
|:---------------------------:|:---------------------------:|:-------------------------------:|:--------------------------------------------------------------:|
| Торговая точка              | Transaction_Store_ID        | ---                             | ---                                                            |
| Идентификатор товара        | SKU_ID                      | ---                             | ---                                                            |
| Закупочная стоимость товара | SKU_Purchase_Price          | Арабская цифра                  | Закупочная стоимость товара для данного магазина               |
| Розничная стоимость товара  | SKU_Retail_Price            | Арабская цифра                  | Стоимость продажи товара без учета скидок для данного магазина |

#### _________________________________________________Таблица Группы SKU_________________________________________________

| **Поле**                    | **Название поля в системе** | **Формат / возможные значения**        | **Описание** |
|:---------------------------:|:---------------------------:|:--------------------------------------:|:------------:|
| Группа SKU                  | Group_ID                    | ---                                    | ---          |
| Название группы             | Group_Name                  | Кириллица или латиница, арабские цифры, спецсимволы | ---          |

#### _________________________________________________Таблица Дата формирования анализа_________________________________________________

| **Поле**                    | **Название поля в системе** | **Формат / возможные значения**        | **Описание** |
|:---------------------------:|:---------------------------:|:--------------------------------------:|:------------:|
| Дата формирования анализа                  | Analysis_Formation                    | дд.мм.гггг чч:мм:сс                                    | ---          |

### Выходные данные

###_________________________________________________Описание вывода вью_________________________________________________

#### _________________________________________________Представление Клиенты_________________________________________________

| **Поле**                                    | **Название поля в системе**    | **Формат / возможные значения**  | **Описание**                                                                  |
|:-------------------------------------------:|:------------------------------:|:--------------------------------:|:-----------------------------------------------------------------------------:|
| Идентификатор клиента                       | Customer_ID                    | ---                              | Уникальное значение                                                           |
| Значение среднего чека                      | Customer_Average_Check         | Арабская цифра, десятичная дробь | Значение среднего чека клиента в рублях за анализируемый период               |
| Сегмент по среднему чеку                    | Customer_Average_Check_Segment | Высокий; Средний; Низкий         | Описание сегмента                                                             |
| Значение частоты транзакций                 | Customer_Frequency             | Арабская цифра, десятичная дробь | Значение частоты визитов клиента в среднем количестве дней между транзакциями. Также учитывается время, т.е. результатом может быть не целое число |
| Сегмент по частоте транзакций               | Customer_Frequency_Segment     | Часто; Средне; Редко             | Описание сегмента                                                             |
| Количество дней после предыдущей транзакции | Customer_Inactive_Period       | Арабская цифра, десятичная дробь | Количество дней, прошедших с даты предыдущей транзакции клиента. Также учитывается время, т.е. результатом может быть не целое число               |
| Коэффициент оттока                          | Customer_Churn_Rate            | Арабская цифра, десятичная дробь | Значение коэффициента оттока клиента                                          |
| Сегмент по коэффициенту оттока              | Customer_Churn_Segment         | Высокий; Средний; Низкий         | Описание сегмента                                                             |
| Номер сегмента                              | Customer_Segment               | Арабская цифра                   | Номер сегмента, к которому принадлежит клиент                                 |
| Идентификатор основного магазина            | Customer_Primary_Store         | ---                              | ---                                                                           |

Сегментация по величине среднего чека

1.  **Формирование списков карт.** Для каждого клиента формируется
    перечень всех его карт на основании данных в полях `Customer_ID` и
    `Customer_Card_ID` таблицы Cards.

2.  **Расчет среднего чека.** Для каждого клиента определяется величина
    среднего чека за анализируемый период. Источник данных – таблица
    Transaction. Суммируются все транзакции по всем картам каждого
    клиента по полю `Transaction_Summ` таблицы Transaction, после
    чего полученная сумма делится на количество транзакций. Полученные
    данные сохраняются в поле `Customer_Average_Check` таблицы Клиенты.

3.  **Ранжирование клиентов.** Все клиенты в выборке ранжируются по
    величине среднего чека (полю `Customer_Average_Check` таблицы Клиенты) от наибольших к наименьшим значениям.

4.  **Определение сегмента.** 10% клиентов с наивысшим показателем
    среднего чека относятся к сегменту `High`. Следующие 25% клиентов с
    наивысшим показателем среднего чека относятся к сегменту `Medium`.
    Оставшиеся клиенты с наименьшим показателем среднего чека относятся
    к сегменту `Low`. Данные указываются в поле
    `Customer_Average_Check_Segment` таблицы Клиенты.

Сегментация по частоте визитов

5.  **Определение интенсивности транзакций.** Для каждого клиента
    определяется его текущая частота визитов в среднем интервале между
    визитами в днях. Для этого из даты самой поздней на момент
    формирования анализа транзакции вычитается дата самой ранней за
    анализируемый период транзакции. Данные берутся из поля
    `Transaction_DateTime` таблицы Transaction. Полученное значение
    делится на общее количество транзакций клиента за анализируемый
    период. Количество транзакций клиента определяется как количество
    уникальных значений в поле `Transaction_ID` для всех карт клиента.
    Полученные данные сохраняются в поле `Customer_Frequency` таблицы
    Клиенты.

6.  **Ранжирование клиентов.** Все клиенты в выборке ранжируются по
    частоте визитов (полю `Customer_Frequency` таблицы Клиенты)
    от наименьших к наибольшим значениям.

7.  **Определение сегмента.** 10% клиентов с наименьшими значениями
    интервалов между визитами обладают наивысшей частотой визитов и
    относятся к сегменту `Often`. Следующие 25% клиентов с наименьшими
    интервалами между визитами относятся к сегменту `Occasionally`. Оставшиеся
    65% клиентов относятся к сегменту `Rarely`. Данные указываются в поле
    `Customer_Frequency_Segment` таблицы Клиенты.

Сегментация по вероятности оттока

8.  **Определение периода после предыдущей транзакции.** Для каждого
    клиента необходимо определить количество дней, прошедших после самой
    поздней на момент анализа транзакции. Для этого из даты формирования анализа (из таблицы) вычитается дата самой поздней транзакции
    клиента. Данные берутся из поля `Transaction_DateTime` таблицы Transaction по всем картам клиента.

9.  **Расчет коэффициента оттока.** Для каждого клиента количество дней,
    прошедших с даты предыдущей транзакции (значение поля
    `Customer_Inactive_Period` таблицы Клиенты), делится на
    интенсивность транзакций клиента в прошлом (значение поля
    `Customer_Frequency` таблицы Клиенты). Получившийся результат сохраняется в поле `Customer_Churn_Rate`
    таблицы Клиенты.

10. **Определение вероятности оттока.** В случае, если полученный
    коэффициент находится в интервале от 0 до 2, вероятность оттока
    клиента оценивается как `Low`. Если коэффициент находится в
    интервале от 2 до 5, вероятность оттока оценивается как `Medium`. В
    случае, если значение превышает 5, присваивается значение `High`.
    Получившийся результат сохраняется в поле `Customer_Churn_Segment`
    таблицы Клиенты.

Присвоение клиенту номера сегмента

11. **Присвоение номера сегмента.** На основании комбинации значений
    клиента в полях `Customer_Average_Check_Segment`,
    `Customer_Frequency_Segment` и `Customer_Churn_Segment` таблицы Клиенты клиенту присваивается номер сегмента в соответствии со
    следующей таблицей:

| **Сегмент** | **Средний чек** | **Частота покупок** | **Вероятность оттока** |
|-------------|-----------------|---------------------|------------------------|
| 1           | Низкий          | Редко               | Низкая                 |
| 2           | Низкий          | Редко               | Средняя                |
| 3           | Низкий          | Редко               | Высокая                |
| 4           | Низкий          | Средне              | Низкая                 |
| 5           | Низкий          | Средне              | Средняя                |
| 6           | Низкий          | Средне              | Высокая                |
| 7           | Низкий          | Часто               | Низкая                 |
| 8           | Низкий          | Часто               | Средняя                |
| 9           | Низкий          | Часто               | Высокая                |
| 10          | Средний         | Редко               | Низкая                 |
| 11          | Средний         | Редко               | Средняя                |
| 12          | Средний         | Редко               | Высокая                |
| 13          | Средний         | Средне              | Низкая                 |
| 14          | Средний         | Средне              | Средняя                |
| 15          | Средний         | Средне              | Высокая                |
| 16          | Средний         | Часто               | Низкая                 |
| 17          | Средний         | Часто               | Средняя                |
| 18          | Средний         | Часто               | Высокая                |
| 19          | Высокий         | Редко               | Низкая                 |
| 20          | Высокий         | Редко               | Средняя                |
| 21          | Высокий         | Редко               | Высокая                |
| 22          | Высокий         | Средне              | Низкая                 |
| 23          | Высокий         | Средне              | Средняя                |
| 24          | Высокий         | Средне              | Высокая                |
| 25          | Высокий         | Часто               | Низкая                 |
| 26          | Высокий         | Часто               | Средняя                |
| 27          | Высокий         | Часто               | Высокая                |

Определение основного магазина клиента

12. **Определение перечня магазинов клиента.** Для каждого клиента для
    всех его карт формируется перечень магазинов, в которых он совершал
    транзакции в течение анализируемого периода. Одному клиенту могут
    соответствовать несколько магазинов. Для этого используется данные,
    содержащиеся в поле `Transaction_Store_ID` таблицы Transaction.
    После формирования список дедублицируется.

13. **Расчет доли транзакций в каждом магазине.** Для каждого магазина,
    в котором клиент совершал покупки, указывается доля транзакций,
    совершенных в этом магазине. Для этого количество уникальных
    транзакций в каждом конкретном магазине делится на общее количество
    уникальных транзакций клиента. Для расчетов используются данные,
    содержащиеся в поле `Transaction_ID` и `Transaction_Store_ID`
    таблицы Transaction.

14. **Определение магазина, в котором клиент совершил три предыдущие
    транзакции.** Для каждого клиента для всех его карт определяется
    магазин или магазины, в котором(-ых) были совершены три самые
    поздние транзакции. Для этого используются данные, содержащиеся в
    полях `Transaction_Store_ID` и `Transaction_DateTime`.

15. **Определение основного магазина клиента.** Для каждого клиента
    определяется его основной магазин. В случае, если три последние
    транзакции совершены в одном и том же магазине, в качестве основного
    магазина клиента устанавливает этот магазин. В ином случае в
    качестве основного магазина клиента указывается магазин, в котором
    совершена наибольшая доля всех транзакций клиента. В случае, если
    для нескольких магазинов указана одинаковая доля транзакций, в
    качестве основного магазина выбирается тот из них, в которым была
    совершена самая поздняя транзакция. Получившееся значение
    указывается в поле `Customer_Primary_Store` таблицы Клиенты.


#### _________________________________________________Представление История покупок_________________________________________________

| **Поле**                        | **Название поля в системе** | **Формат / возможные значения**  | **Описание**                                                                                                                                                                                                 |
|:-------------------------------:|:---------------------------:|:--------------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| Идентификатор клиента           | Customer_ID                 | ---                              | ---                                                                                                                                                                                                          |
| Идентификатор транзакции        | Transaction_ID              | ---                              | ---                                                                                                                                                                                                          |
| Дата транзакции                 | Transaction_DateTime        | гггг-мм-ддTчч:мм:сс.0000000      | Дата совершения транзакции                                                                                                                                                                                   |
| Группа SKU                      | Group_ID                    | ---                              | Идентификатор группы родственных товаров, к которой относится товар (например, одинаковые йогурты одного производителя и объема, но разных вкусов). Указывается один идентификатор для всех товаров в группе |
| Себестоимость                   | Group_Cost                  | Арабская цифра, десятичная дробь | ---                                                                                                                                                                                                          |
| Базовая розничная стоимость     | Group_Summ                  | Арабская цифра, десятичная дробь | ---                                                                                                                                                                                                          |
| Фактически оплаченная стоимость | Group_Summ_Paid             | Арабская цифра, десятичная дробь | ---                                                                                                                                                                                                          |

1.  **Определение транзакций клиента.** Для каждого клиента формируется
    список уникальных транзакций по всем его картам. Для этого
    используются данные, содержащиеся в поле `Transaction_ID` таблицы
    Transaction. Связка с идентификатором клиента (`Customer_ID`
    таблицы Customer) осуществляется через
    идентификаторы всех карт клиента (поле `Customer_Card_ID` таблиц
    Cards и Transaction). Результат сохраняется
    в поле `Transaction_ID` таблицы История покупок. В таблице
    сохраняются уникальные значения Идентификатор клиента
    (`Customer_ID`) – Идентификатор транзакции (`Transaction_ID`).

2.  **Определение дат совершения транзакций.** Для каждой транзакции
    указывается ее дата. Для определения даты совершения транзакции
    используются данные, содержащиеся в поле `Transaction_DateTime` таблицы
    Transaction, идентификация осуществляется по полю
    `Transaction_ID` таблиц История покупок и Transaction.
    Результат сохраняется в поле `Transaction_DateTime` таблицы История покупок.

3.  **Определение списка SKU.** Для каждой транзакции указывается список
    SKU, которые были приобретены клиентом в рамках конкретной
    транзакции. Для этого используются данные, содержащиеся в поле
    `SKU_ID` таблицы Checks. Сопоставление осуществляется на
    основании данных, содержащихся в полях `Transaction_ID` таблиц История покупок и Checks.

4.  **Дедубликация списка SKU.** Список SKU дедублицируется
    индивидуально для каждой транзакции. Для каждой транзакции
    формируется список уникальных SKU.

5. **Определение списка групп.** Для каждого SKU на основании данных из
   товарной матрицы указывается его группа. Для этого используются
   данные, содержащиеся в поле `Group_ID` таблицы Товарная
   матрица, сопоставление осуществляется по полю `SKU_ID` таблиц История покупок и Товарная матрица.

6. **Дедубликация списка групп.** Список групп дедублицируется
   индивидуально для каждой транзакции. Итоговый результат сохраняется
   в поле `Group_ID` таблицы История покупок. В таблице должны
   содержаться уникальные значения, сформированные из совокупности
   данных Идентификатор клиента (`Customer_ID`) – Идентификатор
   транзакции (`Transaction_ID`) – Идентификатор группы (`Group_ID`).
   При этом дата транзакции автоматически распространяется на все
   группы, которые были приобретены в рамках данной транзакции.

7.  **Подсчет финансовых показателей по группе.** Для каждого клиента по
    каждой группе осуществляется подсчет основных финансовых показателей
    путем суммирования аналогичных показателей для всех SKU, входящих в
    конкретную группу. Суммируются данные из таблицы Checks.
    Подсчитываются следующие показатели:

    - Себестоимость купленного клиентом товара в течение 
      анализируемого периода. Суммируются значения, полученные путем умножения данных из поля `SKU_Purchase_Price` на данные из поля `SKU_Amount`
      по всем SKU анализируемой группы для клиента. Данные
      сохраняются в поле `Group_Cost` таблицы purchase_history.

    - Базовая розничная стоимость в течение анализируемого периода.
      Суммируются данные из поля `SKU_Summ` по всем SKU
      анализируемой группы для клиента. Данные сохраняются в поле
      `Group_Summ` таблицы purchase_history.

    - Фактически оплаченная стоимость (с учетом оплаты покупок
      бонусами программы лояльности, но без учета скидок).
      Суммируются данные их поля `SKU_Summ_Paid` по всем SKU
      анализируемой группы для клиента. Данные сохраняются в поле
      `Group_Summ_Paid` таблицы purchase_history.

#### _________________________________________________Представление Периоды_________________________________________________

| **Поле**                            | **Название поля в системе** | **Формат / возможные значения**  | **Описание**                                                                                                                                                                                                 |
|:-----------------------------------:|:---------------------------:|:--------------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| Идентификатор клиента               | Customer_ID                 | ---                              | ---                                                                                                                                                                                                          |
| Идентификатор группы SKU            | Group_ID                    | ---                              | Идентификатор группы родственных товаров, к которой относится товар (например, одинаковые йогурты одного производителя и объема, но разных вкусов). Указывается один идентификатор для всех товаров в группе |
| Дата первой покупки группы          | First_Group_Purchase_Date   | гггг-мм-ддTчч:мм:сс.0000000      | ---                                                                                                                                                                                                          |
| Дата последней покупки группы       | Last_Group_Purchase_Date    | гггг-мм-ддTчч:мм:сс.0000000      | ---                                                                                                                                                                                                          |
| Количество транзакций с группой     | Group_Purchase              | Арабская цифра, десятичная дробь | ---                                                                                                                                                                                                          |
| Интенсивность покупок группы        | Group_Frequency             | Арабская цифра, десятичная дробь | ---                                                                                                                                                                                                          |
| Минимальный размер скидки по группе | Group_Min_Discount          | Арабская цифра, десятичная дробь | ---                                                                                                                                                                                                          |


1. **Определение даты первой покупки группы клиентом.** Дата первой
   покупки группы клиентом определяется на основе данных, содержащихся
   в поле `Transaction_DateTime` таблицы purchase_history. Из всей
   совокупности записей, в рамках которых идентификаторы клиента и
   группы равны идентификаторам клиента и группы анализируемой строки
   таблицы Периоды, выбирается минимальное значение по полю
   `Transaction_DateTime` таблицы purchase_history. Результат
   сохраняется в поле `First_Group_Purchase_Date` таблицы Периоды.

2. **Определение даты последней покупки группы клиентом.** Дата
   последней покупки группы клиентом определяется на основе данных,
   содержащихся в поле `Transaction_DateTime` таблицы История
   покупок. Из всей совокупности записей, в рамках которых
   идентификаторы клиента и группы равны идентификаторам клиента и
   группы анализируемой строки таблицы Периоды, выбирается
   максимальное значение по полю `Transaction_DateTime` таблицы История
   покупок. Результат сохраняется в поле
   `Last_Group_Purchase_Date` таблицы Периоды.

3. **Определение количества транзакций с анализируемой группой.**
   Определяется количество транзакций клиента в рамках анализируемого
   периода, в которых присутствует анализируемая группа. Для этого
   используются данные, содержащиеся в полях `Customer_ID`,
   `Transaction_ID` (берутся уникальные значения по полю
   `Transaction_ID`) и Group_ID (берется идентификатор анализируемой
   группы) таблицы purchase_history. Значения в полях
   `Customer_ID` и `Group_ID` в таблице purchase_history должны
   соответствовать значениям в аналогичных полях таблицы Периоды.
   Результат сохраняется в поле `Group_Purchase` таблицы Периоды.

4. **Определение интенсивности покупок группы.** Для определения
   интенсивности покупок группы из даты последней транзакции с группой
   (значение поля `Last_Group_Purchase_Date` таблицы Периоды)
   вычитается значение поля (значение поля `First_Group_Purchase_Date`
   таблицы Периоды), добавляется единица, после чего результат
   делится на количество транзакций с анализируемой группой (значение
   поля `Group_Purchase` таблицы Периоды). Результат сохраняется
   в поле `Group_Frequency` таблицы Периоды.

5. **Подсчет минимальной скидки по группе.** Для каждой группы каждой
   транзакции устанавливается минимальный размер скидки, который был
   предоставлен в рамках данной транзакции. Для этого предоставленный
   размер скидки по каждому SKU (значение поля `SKU_Discount` таблицы
   Checks) делится на базовую розничную стоимость данного SKU
   (значение поля `SKU_Summ` таблицы Checks). Результат сохраняется
   в поле `Group_Min_Discount` таблицы Периоды. В случае
   отсутствия скидки по всем SKU группы указывается значение 0.

#### _________________________________________________Представление Группы_________________________________________________

| **Поле**                   | **Название поля в системе** | **Формат / возможные значения**  | **Описание**                                                                                                                        |
|:--------------------------:|:---------------------------:|:--------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------:|
| Идентификатор клиента      | Customer_ID                 | ---                              | ---                                                                                                                                 |
| Идентификатор группы       | Group_ID                    | ---                              | ---                                                                                                                                 |
| Индекс востребованности    | Group_Affinity_Index        | Арабская цифра, десятичная дробь | Коэффициент востребованности данной группы клиентом                                                                                 |
| Индекс оттока              | Group_Churn_Rate            | Арабская цифра, десятичная дробь | Индекс оттока клиента по конкретной группе                                                                                          |
| Индекс стабильности        | Group_Stability_Index       | Арабская цифра, десятичная дробь | Показатель, демонстрирующий стабильность потребления группы клиентом                                                                |
| Актуальная маржа по группе | Group_Margin                | Арабская цифра, десятичная дробь | Показатель актуальной маржи по группе для конкретного клиента                                                                       |
| Доля транзакций со скидкой | Group_Discount_Share        | Арабская цифра, десятичная дробь | Доля транзакций по покупке группы клиентом, в рамках которых были применена скидка (без учета списния бонусов программы лояльности) |
| Минимальный размер скидки  | Group_Minimum_Discount      | Арабская цифра, десятичная дробь | Минимальный размер скидки, зафиксированный для клиента по группе                                                                    |
| Средний размер скидки      | Group_Average_Discount      | Арабская цифра, десятичная дробь | Средний размер скидки по группе для клиента                                                                                         |

Определение востребованных групп SKU для каждого клиента

1.  **Формирование списка SKU для клиента.** Для каждого клиента (для
    всех карт клиента) формируется список всех SKU, которые покупал
    клиент в течение анализируемого периода. Для этого используются
    данные, содержащиеся в поле `SKU_ID` таблицы Checks. Для
    идентификации всех транзакций клиента используются данные,
    содержащиеся в полях `Transaction_ID` таблиц Checks и Transactions, `Customer_Card_ID` таблиц Transactions и Cards, `Customer_ID` таблицы PersonalInformation.

2.  **Дедубликация списка SKU.** После формирования из списка SKU
    каждого клиента удаляются дубликаты таким образом, чтобы в
    результате для каждого клиента был сформирован перечень уникальных
    SKU, которые он приобретал в течение анализируемого периода.

3.  **Определение списка востребованных групп для клиента.** Для каждого
    клиента по каждому уникальному SKU на основании данных из товарной
    матрицы указывается группа, к которой относится данный SKU. Для
    этого используются данные, содержащиеся в полях `SKU_ID` и
    `Group_ID` таблицы Товарная матрица.

4.  **Дедубликация списка групп.** После формирования из списка групп,
    востребованных клиентом, удаляются дубликаты таким образом, чтобы в
    результате для каждого клиента был сформирован перечень уникальных
    групп, которые он приобретал в течение анализируемого периода.
    Итоговый результат сохраняется в поле `Group_ID` таблиц Periods и Группы. В таблицах должны содержаться
    уникальные значения, сформированные из пары Идентификатор клиента
    (`Customer_ID`) – Идентификатор группы (`Group_ID`).

Расчет востребованности

5. **Определение общего количества транзакций клиента.** Определяется
   общее количество транзакций клиента, совершенных им между первой и
   последней транзакциями с анализируемой группой (включая транзакции,
   в рамках которых не было анализируемой группы), включая первую и
   последнюю транзакции с группой. Для этого подсчитывается количество
   уникальных значений в поле `Transaction_ID` таблицы purchase_history, дата совершения транзакций для которых больше или равна
   дате первой транзакции клиента с группой (значение поля
   `First_Group_Purchase_Date` таблицы Periods) и меньше или
   равна дате последней транзакции клиента с группой (значение поля
   `Last_Group_Purchase_Date` таблицы Periods).

6. **Расчет индекса востребованности группы.** Количество транзакций с
   анализируемой группой (значение поля `Group_Purchase` таблицы Periods) делится на общее количество транзакций клиента,
   совершенных с первой по последнюю транзакции, в которых была
   анализируемая группа. Итоговое значение
   сохраняется для группы в поле `Group_Affinity_Index` таблицы Группы.

Расчет индекса оттока из группы

7. **Подсчет давности приобретения группы.** Из даты формирования анализа вычитается
   дата последней транзакции клиента, в которой была представлена
   анализируемая группа. Для определения последней даты покупки группы
   клиентом выбирается максимальное значение по полю `Transaction_DateTime`
   таблицы purchase_history для записей, в которых значения полей
   `Customer_ID` и `Group_ID` соответствуют значениям аналогичных полей
   таблицы Группы.

8. **Расчет коэффициента оттока.** Количество дней, прошедших после
   даты последней транзакции клиента с анализируемой группой, делится на среднее количество дней между покупками
   анализируемой группы клиентом (значение поля `Group_Frequency`
   таблицы Periods). Итоговое значение сохраняется в поле
   `Group_Churn_Rate` таблицы Группы.

Расчет стабильности потребления группы

9. **Расчет интервалов потребления группы.** Определяются все интервалы
    (в количестве дней) между транзакциями клиента, содержащими
    анализируемую группу. Для этого все транзакции, содержащие
    анализируемую группу в покупках клиента, ранжируются по дате
    совершения (значению поля `Transaction_DateTime` таблицы purchase_history) от самой ранней к самой поздней. Из даты каждой
    последующей транзакции вычитается дата предыдущей. Каждый интервал
    учитывается отдельно.

10. **Подсчет абсолютного отклонения каждого интервала от средней
    частоты покупок группы.** Из значения каждого интервала вычитается
    среднее количество дней между транзакциями с анализируемой группой
    (значение поля `Group_Frequency` таблицы Periods). В случае,
    если получившееся значение является отрицательным, оно умножается на
    -1.

11. **Подсчет относительного отклонения каждого интервала от средней
    частоты покупок группы.** Получившееся на предыдущем шаге значение для
    каждого интервала делится на среднее количество дней между
    транзакциями с анализируемой группой (значение поля
    `Group_Frequency` таблицы Periods).

12. **Определение стабильности потребления группы.** Показатель
    стабильности потребления группы определяется как среднее значение
    всех показателей, получившихся на предыдущем шаге. Результат сохраняется в
    поле `Group_Stability_Index` таблицы Группы.

Расчет фактической маржи по группе для клиента

13. **Выбор метода расчета маржи.** По умолчанию маржа рассчитывается
    для всех транзакций в рамках анализируемого периода (используются
    все доступные данные). Но пользователь должен иметь возможность
    внести индивидуальные настройки и выбрать метод расчета актуальной
    маржи – по периоду или по количеству транзакций.

    -   В случае выбора метода расчета маржи по периоду пользователь
        указывает, за какое количество дней от даты формирования анализа из таблицы в обратном
        хронологическом порядке необходимо рассчитать маржу. Для
        расчета берутся все транзакции, в которых присутствует
        анализируемая группа, совершенные пользователем в указанный
        период. Для подсчетов используются данные, содержащиеся в поле
        `Transaction_DateTime` таблицы purchase_history.

    -   В случае выбора метода расчета маржи по количеству транзакций
        пользователь указывает количество транзакций, для которых
        необходимо рассчитать маржу. Маржа считается по заданному
        количеству транзакций, начиная с последней, в обратном
        хронологическом порядке. Для подсчетов используются данные,
        содержащиеся в поле `Transaction_DateTime` таблицы История
        покупок`.

14. **Расчет фактической маржи по группе.** Для определения фактической
    маржи группы по клиенту в рамках анализируемого или заданного
    пользователем периода из суммы, на которую был куплен товар (поле
    `Group_Summ_Paid` таблицы purchase_history) вычитается
    себестоимость приобретенного товара (значение поля `Group_Cost`
    таблицы purchase_history). Итоговое значение сохраняется в качестве
    фактической маржи по данной группе для клиента в поле `Group_Margin`
    таблицы Группы.

Анализ предоставления скидок по группе

15. **Определение количества транзакций клиента со скидкой.**
    Определяется количество транзакций, в рамках которых анализируемая
    группа была приобретена клиентом с применением какой-либо скидки.
    Для подсчета используются уникальные значения по полю
    `Transaction_ID` таблицы Checks для транзакций, в рамках которых
    клиент приобретал анализируемую группу, при этом значение поля
    `SKU_Discount` таблицы Checks больше нуля. Скидка,
    представленная в рамках списания бонусных баллов, не учитывается.

16. **Определение доли транзакций со скидкой.** Количество транзакций, в
    рамках которых приобретение товаров из анализируемой группы было
    совершено со скидкой делится на общее
    количество транзакций клиента с анализируемой группой за
    анализируемый период (данные поля `Group_Purchase` таблицы Periods для анализируемой группы по клиенту). Получившееся значения
    сохраняется в качестве доли транзакций по покупке анализируемой
    группы со скидкой в поле `Group_Discount_Share` таблицы Группы.

17. **Определение минимального размера скидки по группе.** Определяется
    минимальный размер скидки по каждой группе для каждого клиента. Для
    этого выбирается минимальное не равное нулю значение поля
    `Group_Min_Discount` таблицы Periods для заданных клиента и
    группы. Результат сохраняется в поле `Group_Minimum_Discount`
    таблицы Группы.

18. **Определение среднего размера скидки по группе.** Для определения
    среднего размера скидки по группе для клиента фактически оплаченная
    сумма по покупке группы в рамках всех транзакций (значение поля
    `Group_Summ_Paid` таблицы purchase_history для всех транзакций)
    делится на сумму розничной стоимости данной группы в рамках всех
    транзакций (сумма по группе по значению поля `Group_Summ` таблицы
    purchase_history). В расчете участвуют только транзакции, в которых была предоставлена скидка. 
    Результат сохраняется в поле `Group_Average_Discount` таблицы Группы.


## _________________________________________________Part 1. Создание базы данных_________________________________________________

Напишите скрипт *part1.sql*, создающий базу данных и таблицы, описанные выше в разделе входные-данные.

Также внесите в скрипт процедуры, позволяющие импортировать и экспортировать данные для каждой таблицы из файлов/в файлы с расширением *.csv* и *.tsv*. \
В качестве параметра каждой процедуры для импорта из *csv* файла указывается разделитель.

В каждую из таблиц внесите как минимум по 5 записей.
По мере выполнения задания вам потребуются новые данные, чтобы проверить все варианты работы.
Эти новые данные также должны быть добавлены в этом скрипте. 
Некоторые тестовые данные могут быть найдены в папке *datasets*.

## _________________________________________________Part 2. Создание представлений_________________________________________________

Создайте скрипт *part2.sql*, в котором напишите представления, описанные выше в разделе выходные данные.
Также внесите в скрипт тестовые запросы для каждого представления. Допустимо для каждого представления создавать отдельный скрипт, начинающийся с *part2_*.

Более подробную информацию для получения каждого поля можно найти в папке materials.

## Part 3. _________________________________________________Ролевая модель_________________________________________________

Внесите в скрипт *part3.sql* создание ролей и выдачу им прав в соответствии с описанным ниже.

####  Администратор
Администратор имеет полные права на редактирование и просмотр
любой информации, запуск и остановку процесса обработки.

####  Посетитель
Только просмотр информации из всех таблиц.

## Part 4. __________________________________Формирование персональных предложений, ориентированных на рост среднего чека__________________________________

Создайте скрипт *part4.sql*, в который внесите описанную далее функцию.

### Написать функцию, определяющую предложения, ориентированные на рост среднего чека

Параметры функции:
- метод расчета среднего чека (1 - за период, 2 - за количество)
- первая и последняя даты периода (для 1 метода)
- количество транзакций (для 2 метода)
- коэффициент увеличения среднего чека
- максимальный индекс оттока
- максимальная доля транзакций со скидкой (в процентах)
- допустимая доля маржи (в процентах)

##### Определение условия предложения

1.  **Выбор метода расчета среднего чека.** Существует возможность
    выбора метода расчета среднего чека – за определенный период времени
    или за определенное количество последних транзакций. Метод расчета
    *вручную определяется* пользователем.

    1.  Пользователь выбирает методику расчета **по периоду**, после чего
        указывает первую и последнюю даты периода, за который
        необходимо рассчитать средний чек для всей совокупности
        клиентов, попавших в выборку. При этом последняя дата
        указываемого периода должна быть позже первой, а указанный
        период должен быть внутри общего анализируемого периода. В
        случае указания слишком ранней или слишком поздней даты
        система автоматически подставляет дату, соответственно, начала
        или окончания анализируемого периода. Для расчета учитываются
        все транзакции, совершенные каждым конкретным клиентом в
        течение заданного периода.

    2.  Пользователь выбирает методику расчета **по количеству последних
        транзакций**, после чего вручную указывает количество
        транзакций, по которым необходимо рассчитать средний чек. Для
        расчета среднего чека берется заданное пользователем
        количество транзакций, начиная с самой последней в обратном
        хронологическом порядке. В случае, если каким-либо клиентом из
        выборки за весь анализируемый период совершено меньше
        указанного количества транзакций, для анализа используется
        имеющееся количество транзакций.

2.  **Определение среднего чека.** Для каждого клиента определяется
    текущее значение его среднего чека согласно выбранному в рамках шага
    1 методу. Для этого общий товарооборот по всем попавшим в выборку
    транзакциям клиента делится на количество этих транзакций. Итоговое
    значение сохраняется в таблице как текущее значение среднего чека.

3.  **Определение целевого значения среднего чека.** Рассчитанное
    значение среднего чека умножается на коэффициент заданный пользователем. Получившееся значение сохраняется в системе
    как целевое значение среднего чека клиента и в дальнейшем
    используется для формирования условия предложения, которое должен
    выполнить клиент для получения вознаграждения.

##### Определение вознаграждения

4.  **Определение группы для формирования вознаграждения.** Для
    формирования вознаграждения выбирается группа, отвечающая
    последовательно следующим критериям:

    -   Индекс востребованности группы – максимальный из всех возможных.

    -   Индекс оттока по данной группе не должен превышать заданного пользователем значения. В случае, если коэффициент оттока превышает
        установленное значение, берется следующая по индексу
        востребованности группа;

    -   Доля транзакций со скидкой по данной группе – менее заданного пользователем значения. В случае, если для выбранной группы превышает
        установленное значение, берется следующая по индексу
        востребованности группа, удовлетворяющая также критерию по
        оттоку.

5.  **Определение максимально допустимого размера скидки для
    вознаграждения.** Пользователь вручную определяет долю маржи (в
    процентах), которую допустимо использовать для предоставления
    вознаграждения по группе. Итоговое значение максимально допустимой
    скидки рассчитывается путем умножения заданного значения на среднюю
    маржу клиента по группе.

6.  **Определение величины скидки.** Значение, полученное на шаге 5,
    сравнивается с минимальной скидкой, которая была зафиксирована для
    клиента по данной группе, округленной вверх с шагом в 5%. В случае,
    если минимальная скидка после округления меньше значения,
    получившегося на шаге 5, она устанавливается в качестве скидки для
    группы в рамках предложения для клиента. В противном случае данная
    группа исключается из рассмотрения, и для формирования предложения
    для клиента процесс повторяется, начиная с шага 4 (используются
    следующая подходящая по описанным критериям группа).

Вывод функции:

| **Поле**                       | **Название поля в системе** | **Формат / возможные значения**            | **Описание**                                                                               |
|--------------------------------|-----------------------------|--------------------------------------------|--------------------------------------------------------------------------------------------|
| Идентификатор клиента          | Customer_ID                 |                                            |                                                                                            |
| Целевое значение среднего чека | Required_Check_Measure      | Арабская цифра (десятичная дробь)          | Целевое значение среднего чека, необходимое для получения вознаграждения                   |
| Группа предложения             | Group_Name                  |                                            | Название группы предложения, на которой начисляется вознаграждение при выполнении условия. |
| Максимальная глубина скидки    | Offer_Discount_Depth        | Арабская цифра (десятичная дробь), процент | Максимально возможный размер скидки для предложения                                        |

## Part 5. __________________________________Формирование персональных предложений, ориентированных на рост частоты визитов__________________________________

Создайте скрипт *part5.sql*, в который внесите описанную далее функцию.

### Написать функцию, определяющую предложения, ориентированные на рост частоты визитов
Параметры функции:
- первая и последняя даты периода
- добавляемое число транзакций
- максимальный индекс оттока
- максимальная доля транзакций со скидкой (в процентах)
- допустимая доля маржи (в процентах)

##### Определение условия предложения

1. **Определение периода.** Пользователь вручную задает период действия разрабатываемого предложения, указывая первую и конечную его даты.

2. **Определение текущей частоты посещений клиента в заданный период.**
   Из конечной даты заданного периода вычитается первая дата,
   после чего полученное значение делится на среднюю интенсивность транзакций клиента (поле `Customer_Frequency` Customers).
   Итоговый результат сохраняется в качестве базовой интенсивности транзакций клиента в течение заданного периода.

3. **Определение транзакции для начисления вознаграждения.**
   Система определяет порядковый номер транзакции в рамках заданного периода, на которую должно быть начислено вознаграждение.
   Для этого значение, полученное на шаге 2, округляется согласно арифметическим правилам до целого,
   после чего к нему добавляется число транзакций, заданное пользователем.
   Итоговое значение является целевым количеством транзакций, которое должен совершить клиент для получения вознаграждения.

##### Определение вознаграждения

4.  **Определение группы для формирования вознаграждения.** Для
    формирования вознаграждения выбирается группа, отвечающая
    последовательно следующим критериям:

    -  Индекс востребованности группы – максимальный из всех возможных.

    -  Индекс оттока по данной группе не должен превышать заданного пользователем значения. В случае, если коэффициент оттока превышает
       установленное значение, берется следующая по индексу
       востребованности группа;

    -  Доля транзакций со скидкой по данной группе – менее заданного пользователем значения. В случае, если для выбранной группы превышает
       установленное значение, берется следующая по индексу
       востребованности группа, удовлетворяющая также критерию по
       оттоку.

5.  **Определение максимально допустимого размера скидки для
    вознаграждения.** Пользователь вручную определяет долю маржи (в
    процентах), которую допустимо использовать для предоставления
    вознаграждения по группе. Итоговое значение максимально допустимой
    скидки рассчитывается путем умножения заданного значения на среднюю
    маржу клиента по группе.

6.  **Определение величины скидки.** Значение, полученное на шаге 5,
    сравнивается с минимальной скидкой, которая была зафиксирована для
    клиента по данной группе, округленной вверх с шагом в 5%. В случае,
    если минимальная скидка после округления меньше значения,
    получившегося на шаге 5, она устанавливается в качестве скидки для
    группы в рамках предложения для клиента. В противном случае данная
    группа исключается из рассмотрения, и для формирования предложения
    для клиента процесс повторяется, начиная с шага 4 (используются
    следующая подходящая по описанным критериям группа).

Вывод функции:

| **Поле**                      | **Название поля в системе** | **Формат / возможные значения**            | **Описание**                                                                               |
|-------------------------------|-----------------------------|--------------------------------------------|--------------------------------------------------------------------------------------------|
| Идентификатор клиента         | Customer_ID                 |                                            |                                                                                            |
| Дата начала периода           | Start_Date                  | гггг-мм-ддTчч:мм:сс.0000000                | Дата начала периода, в течение которого необходимо совершить транзакции                    |
| Дата окончания периода        | End_Date                    | гггг-мм-ддTчч:мм:сс.0000000                | Дата окончания периода, в течение которого необходимо совершить транзакции                 |
| Целевое количество транзакций | Required_Transactions_Count | Арабская цифра (десятичная дробь)          | Порядковый номер транзакции, на которую начисляется вознаграждение                         |
| Группа предложения            | Group_Name                  |                                            | Название группы предложения, на которой начисляется вознаграждение при выполнении условия. |
| Максимальная глубина скидки   | Offer_Discount_Depth        | Арабская цифра (десятичная дробь), процент | Максимально возможный размер скидки для предложения                                        |

## Part 6. __________________________________Формирование персональных предложений, ориентированных на кросс-продажи__________________________________

Создайте скрипт *part6.sql*, в который внесите описанную далее функцию.

### Написать функцию, определяющую предложения, ориентированные на кросс-продажи (рост маржи)
Параметры функции:
- количество групп
- максимальный индекс оттока
- максимальный индекс стабильности потребления
- максимальная доля SKU (в процентах)
- допустимая доля маржи (в процентах)

Предложения, ориентированные на рост маржи за счет кросс-продаж,
подразумевают переключение клиента на максимально маржинальное SKU в
рамках востребованной им группы.

1.  **Выбор групп.** Для формирования предложений, ориентированных на
    рост маржи за счет кросс-продаж, для каждого клиента выбирается несколько
    групп (количество *задается* пользователем) с
    максимальным индексом востребованности, отвечающие следующим
    условиям:

    1.  Индекс оттока по группе не более заданного пользователем значения.

    2.  Индекс стабильности потребления группы составляет менее заданного пользователем значения.

2.  **Определение SKU с максимальной маржой.** В каждой группе
    определяется SKU с максимальной маржой (в рублях). Для этого по
    основному магазину клиента из розничной цены товара
    (`SKU_Retail_Price`) вычитается его закупочная стоимость
    (`SKU_Purchase_Price`) для всех SKU данной группы, представленных
    в магазине, после чего выбирается одно SKU с максимальным
    значением указанной разницы.

3.  **Определение доли SKU в группе.** Определяется доля транзакций, в
    которых присутствует анализируемое SKU. Для этого количество
    транзакций, содержащих данный SKU, делится на количество
    транзакций, содержащих группу в целом (за анализируемый период).
    SKU используется для формирования предложения только в том случае,
    если получившееся значение не превышает заданного пользователем значения.

4.  **Определение доли маржи для расчета скидки.** Пользователь *вручную
    определяет* долю маржи (в процентах), которую допустимо
    использовать для предоставления вознаграждения по SKU (задается
    единое значение для всей совокупности клиентов).

5.  **Расчет скидки.** *Заданное* пользователем на шаге 4 значение
    умножается на разницу между розничной (`SKU_Retail_Price`) и
    закупочной (`SKU_Purchase_Price`) ценой, а получившееся значение
    делится на розничную цену SKU (`SKU_Retail_Price`). Все цены – для
    основного магазина клиента. В случае, если получившееся значение
    равно или превышает минимальный размер скидки пользователя для
    анализируемой группы, округленной вверх с шагом в 5%, то в
    качестве скидки для данного SKU для клиента устанавливается
    минимальная скидка для группы, округленная вверх с шагом в 5%. В
    противном случае для клиента не формируется предложение по данной
    группе.

Вывод функции:

| **Поле**                    | **Название поля в системе** | **Формат / возможные значения**            | **Описание**                                                                            |
|-----------------------------|-----------------------------|--------------------------------------------|-----------------------------------------------------------------------------------------|
| Идентификатор клиента       | Customer_ID                 |                                            |                                                                                         |
| SKU предложения             | SKU_Name                    |                                            | Название SKU предложения, на который начисляется вознаграждение при выполнении условия. |
| Максимальная глубина скидки | Offer_Discount_Depth        | Арабская цифра (десятичная дробь), процент | Максимально возможный размер скидки для предложения                                     |
